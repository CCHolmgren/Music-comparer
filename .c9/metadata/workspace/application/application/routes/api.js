{"changed":true,"filter":false,"title":"api.js","tooltip":"/application/application/routes/api.js","value":"/**\n * Created by Chrille on 2015-01-05.\n */\nvar express = require('express');\nvar router = express.Router();\nvar settings = require('../settings/settings');\nvar redis = require('redis'),\n    client = redis.createClient();\nvar Q = require('q');\n\nvar spotify = settings.Spotify;\nvar LastFM = settings.LastFM;\n\nclient.on(\"error\", function (err) {\n    console.log(\"Error \" + err);\n});\nclient.on(\"connect\", function () {\n    console.log(\"Connected!\");\n});\nvar render_json_data = function (res, data) {\n    data = data.map(JSON.parse);\n    res.render(\"result2\", {data: data});\n};\nvar send_bad_request_response = function(res, message){\n    res.status(400).send({\n        error: \"400 Bad Request\",\n        message: message\n    });\n};\nrouter.get('/latestsearches', function(req, res) {\n    console.log(\"Going into latestsearches\");\n    Q.ninvoke(client, 'lrange', [\"latestsearches\", -5, -1]).then(function(result){\n        console.log(\"Got result\", result);\n        res.header('Content-Type', 'application/json');\n        res.send(JSON.stringify(result));\n    }).done();\n});\nrouter.post('/search2', function (req, res) {\n    var data_expiry_time = 10000;\n    var query_string = req.body.query.toLowerCase().trim();\n\n    if(query_string == \"\"){\n        send_bad_request_response(\"The query must contain something, it can't be empty\");\n        return;\n    }\n\n    console.log(\"Going into the search2 function\");\n\n    Q.longStackSupport = true;\n\n    console.log(\"body:\", query_string);\n\n    process.nextTick(function(){\n        client.lpush(\"latestsearches\", req.body.query, redis.print);\n    });\n\n    Q.ninvoke(client, \"get\", \"artist:\" + query_string).\n        then(function (data) {\n            console.log(data);\n\n            if (data && data.length) {\n                console.log(\"Retrieved data from the cache\");\n\n                return [data, []];\n            } else {\n                console.log(\"Doing the promiserinos\");\n                return [[], Q.allSettled([spotify.artist.get_details_without_artist_before(query_string), \n                    LastFM.artist.get_info(query_string)])]; //TODO: Since LastFM got more data than Spotify got, use the Spotify data to search for LastFM artist. This would be made by searching only spotify data, and then use the returned data for the lastfm search. It works for Muse and such, but less popular things get odd results.\n            }\n        }, function (error) {\n            console.log(\"Well shit: \", error);\n        }).\n        spread(function (cached_data, retrieved_data) {\n            console.log(\"Inside the next step\");\n            if (cached_data.length) {\n                console.log(\"Rendering the cached data\");\n\n                //res.render(\"result2\", {data: JSON.parse(cached_data)});\n                res.send({data: JSON.parse(cached_data)});\n            } else {\n                console.log(typeof retrieved_data);\n                console.log(retrieved_data);\n\n                //The values in the fulfilled or rejected promises are stringified\n                //so we need to parse them to get usable values\n\n                if(retrieved_data[0].state === \"fulfilled\"){\n                    console.log(\"Did it throw here?\");\n                    retrieved_data[0].value = JSON.parse(retrieved_data[0].value);\n                }\n                if(retrieved_data[1].state === \"fulfilled\"){\n                    console.log(\"Or here?\");\n                    retrieved_data[1].value = JSON.parse(retrieved_data[1].value);\n                }\n\n                console.log(\"Sending new data\");\n                //res.render(\"result2\", {data: retrieved_data});\n                res.send({data: retrieved_data});\n\n                console.log(\"Saving the data to the cache\");\n\n                //JSON.stringify will block, so we timeout to get better percieved performance\n                process.nextTick(function () {\n                    client.set(\"artist:\" + query_string, JSON.stringify(retrieved_data), redis.print);\n                    client.expire(\"artist:\" + query_string, data_expiry_time, redis.print);\n                });\n            }\n        }, function (error) {\n            console.log(\"Error\", error);\n        }).\n        catch(function (error) {\n            console.log(\"An error was thrown.\");\n            console.log(error);\n            console.log(error.stack());\n        });\n});\nrouter.post('/search', function (req, res) {\n    Q.longStackSupport = true;\n    if (req.body.query1 == \"\" || req.body.query2 == \"\") {\n        res.status(400).send({\n            error: \"400 Bad Request\",\n            message: \"You provided only 1 or even 0 of the required 2 names. As such we can't go on with the query.\"\n        });\n        return;\n    }\n    Q.spread([Q.ninvoke(client, \"get\", \"artist:\" + req.body.query1), Q.ninvoke(client, \"get\", \"artist:\" + req.body.query2)], function (query1, query2) {\n        //console.log(query1, query2);\n        return [[query1, query2], Q.all([spotify.artist.search(req.body.query1),\n            spotify.artist.search(req.body.query2)])];\n    }).spread(function (cached_data, spotify_search_results) {\n\n        //console.log(spotify_search_results);\n        spotify_search_results = [JSON.parse(spotify_search_results[0]), JSON.parse(spotify_search_results[1])];\n        //console.log(spotify_search_results);\n        //console.log(\"Do we get here?\");\n\n        return [cached_data, Q.all([spotify.artist.get_details(spotify_search_results[0].artists.items[0].id),\n            spotify.artist.get_details(spotify_search_results[1].artists.items[0].id),\n            LastFM.artist.get_info(req.body.query1),\n            LastFM.artist.get_info(req.body.query2)])]\n    }).spread(function (cached_data, data1) {\n        spotify_details1 = JSON.parse(data1[0]);\n        spotify_details2 = JSON.parse(data1[1]);\n        lastfminfo1 = JSON.parse(data1[2]);\n        lastfminfo2 = JSON.parse(data1[3]);\n        //console.log(arguments);\n        //console.log(\"This is my other data:\", cached_data);\n        //console.log(\"Or maybe this:\", data1);\n        console.log(\"Is this where it fails?\");\n        res.render(\"result\", {\n            data1: cached_data[0] || spotify_details1,\n            data2: cached_data[1] || spotify_details2,\n            data3: lastfminfo1,\n            data4: lastfminfo2\n        });\n    }).fail(function (error) {\n        throw new Error(error);\n    }).done();\n});\n\nmodule.exports = router;","undoManager":{"mark":30,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":66,"column":338},"end":{"row":66,"column":339},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":339},"end":{"row":66,"column":340},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":340},"end":{"row":66,"column":341},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":341},"end":{"row":66,"column":342},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":342},"end":{"row":66,"column":343},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":343},"end":{"row":66,"column":344},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":344},"end":{"row":66,"column":345},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":345},"end":{"row":66,"column":346},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":346},"end":{"row":66,"column":347},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":347},"end":{"row":66,"column":348},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":348},"end":{"row":66,"column":349},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":349},"end":{"row":66,"column":350},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":350},"end":{"row":66,"column":351},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":351},"end":{"row":66,"column":352},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":352},"end":{"row":66,"column":353},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":106},"end":{"row":67,"column":0},"action":"insert","lines":["",""]},{"start":{"row":67,"column":0},"end":{"row":67,"column":16},"action":"insert","lines":["                "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":16},"end":{"row":67,"column":20},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":82},"end":{"row":68,"column":0},"action":"insert","lines":["",""]},{"start":{"row":68,"column":0},"end":{"row":68,"column":20},"action":"insert","lines":["                    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":20},"end":{"row":68,"column":21},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":21},"end":{"row":68,"column":22},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":20},"end":{"row":68,"column":24},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":24},"end":{"row":68,"column":28},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":28},"end":{"row":68,"column":32},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":32},"end":{"row":68,"column":36},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":36},"end":{"row":68,"column":40},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":40},"end":{"row":68,"column":44},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":44},"end":{"row":68,"column":48},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":48},"end":{"row":68,"column":52},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":52},"end":{"row":68,"column":56},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":56},"end":{"row":68,"column":60},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":81},"end":{"row":68,"column":62},"action":"remove","lines":[" ","                                                            //"]},{"start":{"row":67,"column":81},"end":{"row":67,"column":82},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":267},"end":{"row":67,"column":268},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":268},"end":{"row":67,"column":269},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":269},"end":{"row":67,"column":270},"action":"insert","lines":["I"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":270},"end":{"row":67,"column":271},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":271},"end":{"row":67,"column":272},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":272},"end":{"row":67,"column":273},"action":"insert","lines":["w"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":273},"end":{"row":67,"column":274},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":274},"end":{"row":67,"column":275},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":275},"end":{"row":67,"column":276},"action":"insert","lines":["k"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":276},"end":{"row":67,"column":277},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":277},"end":{"row":67,"column":278},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":278},"end":{"row":67,"column":279},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":279},"end":{"row":67,"column":280},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":280},"end":{"row":67,"column":281},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":281},"end":{"row":67,"column":282},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":282},"end":{"row":67,"column":283},"action":"insert","lines":["M"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":283},"end":{"row":67,"column":284},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":284},"end":{"row":67,"column":285},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":285},"end":{"row":67,"column":286},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":286},"end":{"row":67,"column":287},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":287},"end":{"row":67,"column":288},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":288},"end":{"row":67,"column":289},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":289},"end":{"row":67,"column":290},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":290},"end":{"row":67,"column":291},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":291},"end":{"row":67,"column":292},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":292},"end":{"row":67,"column":293},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":293},"end":{"row":67,"column":294},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":294},"end":{"row":67,"column":295},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":295},"end":{"row":67,"column":296},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":296},"end":{"row":67,"column":297},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":297},"end":{"row":67,"column":298},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":298},"end":{"row":67,"column":299},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":299},"end":{"row":67,"column":300},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":300},"end":{"row":67,"column":301},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":301},"end":{"row":67,"column":302},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":302},"end":{"row":67,"column":303},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":303},"end":{"row":67,"column":304},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":304},"end":{"row":67,"column":305},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":305},"end":{"row":67,"column":306},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":306},"end":{"row":67,"column":307},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":307},"end":{"row":67,"column":308},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":308},"end":{"row":67,"column":309},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":309},"end":{"row":67,"column":310},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":310},"end":{"row":67,"column":311},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":311},"end":{"row":67,"column":312},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":312},"end":{"row":67,"column":313},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":313},"end":{"row":67,"column":314},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":314},"end":{"row":67,"column":315},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":315},"end":{"row":67,"column":316},"action":"insert","lines":["h"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":316},"end":{"row":67,"column":317},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":317},"end":{"row":67,"column":318},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":318},"end":{"row":67,"column":319},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":319},"end":{"row":67,"column":320},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":320},"end":{"row":67,"column":321},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":321},"end":{"row":67,"column":322},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":322},"end":{"row":67,"column":323},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":323},"end":{"row":67,"column":324},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":324},"end":{"row":67,"column":325},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":325},"end":{"row":67,"column":326},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":326},"end":{"row":67,"column":327},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":327},"end":{"row":67,"column":328},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":328},"end":{"row":67,"column":329},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":329},"end":{"row":67,"column":330},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":330},"end":{"row":67,"column":331},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":331},"end":{"row":67,"column":332},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":332},"end":{"row":67,"column":333},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":333},"end":{"row":67,"column":334},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":334},"end":{"row":67,"column":335},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":335},"end":{"row":67,"column":336},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":336},"end":{"row":67,"column":337},"action":"insert","lines":["."]}]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":66,"column":90},"end":{"row":66,"column":90},"isBackwards":true},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1420714371114}