{% extends "layout.html" %}
{% block content %}
    <script src="/javascripts/chart.js"></script>
    <style>
        .docs-header {
            text-transform: uppercase;
            font-size: 1.4rem;
            letter-spacing: .2rem;
            font-weight: 600;
        }

        .box {
            margin-top: 1.5rem;
            border: 1px solid #E1E1E1;
            padding: 2.5rem 3rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }
    </style>
    <section style="border-bottom: 1px solid #E1E1E1;">
        <h1>{{ title }}</h1>

        <p>Welcome to {{ title }}!</p>

        <p id="online">You are currently online. You may do any search that you like.</p>
        {% if not authenticated %}
            <a href="http://www.last.fm/api/auth/?api_key=88608a3b670729c1f85fe44b231aff72">Login with Last.fm</a>
        {% else %}
            <p>You are authenticated as {{ username }}</p>
        {% endif %}
    </section>
    <div class="box">
        <h6 class="docs-header">Latest searches</h6>

        <div id="latestsearches">
            {% for search in latestsearches %}
                <div>
                    <span>{{ search }}</span>

                    <div>
                        <button onclick="putInSearchBox({{ search }})">Searchbox 1</button>
                        <button onclick="putInSearchBox2({{ search }})">Searchbox 2</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="row">
        <div class="five columns">
            <input type="text" name="query1" placeholder="Text" id="query1"/>

            <p>Test</p>
        </div>
        <div class="two columns">
            <input class="btn" id="compare" type="submit" value="Compare!"/>
        </div>
        <div class="five columns">
            <input class="u-pull-right" type="text" name="query2" placeholder="Text" id="query2"/>

            <p>Test</p>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p id="loading"></p>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div id="charts">
                <canvas id='follower_canvas' width='400' height='400'></canvas>
                <canvas id='listeners_canvas' width='400' height='400'></canvas>
                <canvas id='playcount_canvas' width='400' height='400'></canvas>
                <span>Popularity</span>
                <canvas id='popularity_canvas' width='100' height='100'></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <table class="u-full-width">
                <thead>
                <tr>
                    <th>Artist name</th>
                    <th>Followers</th>
                    <th>Playcount</th>
                    <th>Listeners</th>
                    <th>Popularity</th>
                </tr>
                </thead>
                <tbody id="tbody_data">
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div id="result">

            </div>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div id="result2">
                <canvas id='result2_canvas' width='400' height='400'></canvas>
            </div>
        </div>
    </div>

    {% if result %}
        <pre>
        <code>
            {{ result }}
        </code>
    </pre>
    {% endif %}
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/javascripts/please.min.js"></script>
    <script>
        var searchCount = 0;
        function addCommas(nStr) {
            nStr += '';
            x = nStr.split('.');
            x1 = x[0];
            x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ' ' + '$2');
            }
            return x1 + x2;
        }
        function search(query, type, callback) {
            searchCount+=1;
            console.log(query);
            if (localStorage.getItem(query)) {
                console.log("Got item from storage");
                console.log(JSON.parse(localStorage.getItem(query)));
                callback(JSON.parse(localStorage.getItem(query)));
                return;
            }
            type = type || "artist";
            $.ajax({
                method: "post",
                url: "http://192.168.1.5:3000/api/search2",
                data: {query: query, type: type},
                error: function (x, y, z) {
                    console.log(arguments);
                    console.log(x);
                    $("#loading").text(x.responseJSON.message);
                }
            }).done(function (data, y, z) {
                console.log(arguments);
                console.log(data);
                callback(data);
                localStorage.setItem(query, JSON.stringify(data));
            });
        }
        window.addEventListener("offline", function (e) {
            $("#online").text("You are currently offline. As such you will not be able to do any searches that you haven't already cached. Sorry for the inconvenience.");
        });
        window.addEventListener("online", function (e) {
            $("#online").text("You are currently online. You may do any search that you like.");
        });
        function putInSearchBox(text) {
            console.log(arguments);
            text = decodeURI(text);
            $("#query1").val(text);
        }
        function putInSearchBox2(text) {
            console.log(arguments);
            text = decodeURI(text);
            $("#query2").val(text);
        }
        function getLatestSearches() {
            $.ajax({method: 'GET', url: '/api/latestsearches'}).done(function (result) {
                var div = $("#latestsearches");

                div.empty();

                result.forEach(function (item) {
                    var onclick = "$(\'#query1\').val(\'" + item + "\')";
                    var onclick2 = "$(\'#query2\').val(\'" + item + "\')";
                    var item_uri = encodeURI(item);
                    div.append("<div><span>"
                    + item
                    + "</span><div><button onclick=putInSearchBox('"
                    + item_uri
                    + "')>Searchbox 1</button><button onclick=putInSearchBox2('"
                    + item_uri
                    + "')>Searchbox 2</button></div>")
                });
                //setTimeout(getLatestSearches, 10000);
                console.log(arguments);
            });
        }
        window.onload = function () {
            initializeCharts();
            getLatestSearches();
            //alert(navigator.onLine);
            if (!navigator.onLine) {
                $("#online").text("You are currently offline");
                $("#online").text(navigator.onLine);
            }
            console.log("Adding eventlistener");
            document.getElementById("compare").addEventListener("click", function (e) {
                e.preventDefault();

                popularity_chart.segments = [];
                $("#tbody_data").empty();
                if ($("[name=query1]")[0].value != "") {
                    search($("[name=query1]")[0].value, "artist", handleData.bind(undefined, "#result", 0));
                }
                if ($("[name=query2]")[0].value) {
                    search($("[name=query2]")[0].value, "artist", handleData.bind(undefined, "#result2", 1));
                }
            });
        };
        function initializeCharts() {
            first_color = Please.make_color({
                base_color: "orangered",
                saturation: 0.9,
                value: 0.6
            });
            second_color = Please.make_color({
                base_color: "cyan",
                saturation: 0.9,
                value: 0.6
            });
            var follower_data = {
                labels: [
                    "Followers"
                ],
                datasets: [
                    {
                        label: "My first dataset",
                        fillColor: first_color,
                        data: [0]
                    },
                    {
                        label: "My second dataset",
                        fillColor: second_color,
                        data: [0]
                    }
                ]
            };
            var listeners_data = {
                labels: [
                    "Listeners"
                ],
                datasets: [
                    {
                        label: "My first dataset",
                        fillColor: first_color,
                        data: [0]
                    },
                    {
                        label: "My second dataset",
                        fillColor: second_color,
                        data: [0]
                    }
                ]
            };
            var playcount_data = {
                labels: [
                    "Playcount"
                ],
                datasets: [
                    {
                        label: "My first dataset",
                        fillColor: first_color,
                        data: [0]
                    },
                    {
                        label: "My second dataset",
                        fillColor: second_color,
                        data: [0]
                    }
                ]
            };
            var popularity_data = [];

            var follower_ctx = follower_canvas.getContext("2d");
            var listeners_ctx = listeners_canvas.getContext("2d");
            var playcount_ctx = playcount_canvas.getContext("2d");
            var popularity_ctx = popularity_canvas.getContext("2d");

            follower_chart = new Chart(follower_ctx).Bar(follower_data);
            listeners_chart = new Chart(listeners_ctx).Bar(listeners_data);
            playcount_chart = new Chart(playcount_ctx).Bar(playcount_data);
            popularity_chart = new Chart(popularity_ctx).Doughnut();
        }
        function handleData(target, offset, data) {
            var colors = [first_color, second_color];

            $(target).html("<pre><code>" + JSON.stringify(data, undefined, 2) + "</code></pre>");
            var follower_canvas = document.getElementById("follower_canvas");
            var listeners_canvas = document.getElementById("listeners_canvas");
            var playcount_canvas = document.getElementById("playcount_canvas");
            var popularity_canvas = document.getElementById("popularity_canvas");

            console.log("Target", target);
            console.log("Arguments", arguments);
            console.log("Got data", data);

            var spotify = data.data[0].value;
            console.log("Error thrown here?");
            var lastfm = data.data[1].value;
            $("#tbody_data").append("<tr><td>" + lastfm.artist.name + "</td><td>" + addCommas(spotify.followers.total) + "</td><td>" + addCommas(lastfm.artist.stats.playcount) + "</td><td>" + addCommas(lastfm.artist.stats.listeners) + "</td><td>" + spotify.popularity + "</td></tr>");
            console.log(offset);
            console.log(follower_chart);
            follower_chart.datasets[offset].bars[0].value = spotify.followers.total;
            listeners_chart.datasets[offset].bars[0].value = lastfm.artist.stats.listeners;
            playcount_chart.datasets[offset].bars[0].value = lastfm.artist.stats.playcount;
            popularity_chart.addData(
                    {
                        value: spotify.popularity,
                        color: colors[offset],
                        highlight: Please.make_color({
                            base_color: offset === 0 ? "orangered" : "cyan",
                            saturation: 0.4,
                            value: 0.6
                        }),
                        label: "Popularity"
                    });
            console.log("Or here?");
            follower_chart.update();
            listeners_chart.update();
            playcount_chart.update();
            popularity_chart.update();
        }
    </script>
{% endblock %}