{% extends "layout.html" %}
{% block content %}
    <style>
        .docs-header {
            text-transform: uppercase;
            font-size: 1.4rem;
            letter-spacing: .2rem;
            font-weight: 600;
        }
        .box {
            margin-top: 1.5rem;
            border: 1px solid #E1E1E1;
            padding: 2.5rem 3rem;
            border-radius:4px;
            margin-bottom: 1.5rem;
        }
    </style>
    <section style="border-bottom: 1px solid #E1E1E1;">
        <h1>{{ title }}</h1>
        <p>Welcome to {{ title }}!</p>
        <p id="online">You are currently online. You may do any search that you like.</p>
    </section>
    <div class="box">
        <h6 class="docs-header">Latest searches</h6>
        <div id="latestsearches">
            {% for search in latestsearches %}
                <div>
                    <span>{{ search }}</span>
                    <div>
                        <button onclick="$('#query1').val('{{ search }}')">Searchbox 1</button>
                        <button onclick="$('#query2').val('{{ search }}')">Searchbox 2</button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="row">
            <div class="five columns">
                <input type="text" name="query1" placeholder="Text" id="query1" />
                <p>Test</p>
            </div>
            <div class="two columns">
                <input class="btn" id="compare" type="submit" value="Compare!"/>
            </div>
            <div class="five columns">
                <input class="u-pull-right" type="text" name="query2" placeholder="Text" id="query2"/>
                <p>Test</p>
            </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <p id="loading"></p>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div id="result"></div>
        </div>
    </div>
    <div class="row">
        <div class="twelve columns">
            <div id="result2"></div>
        </div>
    </div>

    {% if result %}
        <pre>
        <code>
            {{ result }}
        </code>
    </pre>
    {% endif %}
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
        function search(query, type, callback){
            console.log(query);
            if(localStorage.getItem(query)){
                console.log("Got item from storage");
                console.log(JSON.parse(localStorage.getItem(query)));
                callback(JSON.parse(localStorage.getItem(query)));
                return;
            }
            type = type || "artist";
            $.ajax({
                method: "post",
                url: "http://192.168.1.5:3000/api/search2",
                data: {query: query, type: type},
                error: function(x,y,z){
                    console.log(arguments);
                    console.log(x);
                    $("#loading").text(x.responseJSON.message);
                }
            }).done(function (data, y, z) {
                console.log(arguments);
                console.log(data);
                callback(data);
                localStorage.setItem(query, JSON.stringify(data));
            });
        }
        window.addEventListener("offline", function(e){
            $("#online").text("You are currently offline. As such you will not be able to do any searches that you haven't already cached. Sorry for the inconvenience.");
        });
        window.addEventListener("online", function(e){
            $("#online").text("You are currently online. You may do any search that you like.");
        });
        function putInSearchBox(text){
            console.log(arguments);
            text = decodeURI(text);
            $("#query1").val(text);
        }
        function getLatestSearches(){
            $.ajax({method:'GET',url:'/api/latestsearches'}).done(function(result){
                var div = $("#latestsearches");

                div.empty();

                result.forEach(function(item){
                    var onclick = "$(\'#query1\').val(\'"+item+"\')";
                    var onclick2 = "$(\'#query2\').val(\'"+item+"\')";
                    var item_uri = encodeURI(item);
                   div.append("<div><span>"+item+"</span><div><button onclick=putInSearchBox('"+item_uri+"')>Searchbox 1</button><button onclick=putInSearchBox('"+item_uri+"')>Searchbox 2</button></div>")
                });
                //setTimeout(getLatestSearches, 1000);
                console.log(arguments);
            });
        }
        window.onload = function () {
            getLatestSearches();
            //alert(navigator.onLine);
            if(!navigator.onLine){
                $("#online").text("You are currently offline");
                $("#online").text(navigator.onLine);
            }
            console.log("Adding eventlistener");
            document.getElementById("compare").addEventListener("click", function(e){
                e.preventDefault();
                if($("[name=query1]")[0].value != ""){
                    search($("[name=query1]")[0].value, "artist", handleData.bind(undefined, "#result"));
                }
                if($("[name=query2]")[0].value){
                    search($("[name=query2]")[0].value, "artist", handleData.bind(undefined, "#result2"));
                }
            });
        };
        function handleData(target, data){
            console.log("Target", target);
            console.log("Arguments", arguments);
            console.log("Got data", data);
            $(target).html(JSON.stringify(data));
        }
    </script>
{% endblock %}